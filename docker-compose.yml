services:
  tiny-gateway:
    image: ${TINY_GATEWAY_IMAGE:-ghcr.io/paul-callahan/tiny-gateway:latest}
    build: .
    container_name: tiny-gateway
    ports:
      - "${TINY_GATEWAY_PORT:-8000}:8000"
    environment:
      - CONFIG_FILE=${TINY_GATEWAY_CONFIG_PATH_IN_CONTAINER:-/app/config/config.yml}
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-me}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - type: bind
        source: ${TINY_GATEWAY_CONFIG_FILE:-./sample-configs/basic-single-tenant.yml}
        target: ${TINY_GATEWAY_CONFIG_PATH_IN_CONTAINER:-/app/config/config.yml}
        read_only: true
    depends_on:
      - mock-backend
    networks:
      - gateway-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  mock-backend:
    image: hashicorp/http-echo:1.0.0
    container_name: tiny-gateway-mock-backend
    command:
      - "-listen=:8080"
      - "-type=application/json"
      - '-text={"service":"mock-backend","status":"ok"}'
    networks:
      - gateway-network
    restart: unless-stopped

networks:
  gateway-network:
    driver: bridge
    name: gateway-network
